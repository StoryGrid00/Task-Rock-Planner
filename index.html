<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker - Smart Money Management</title>
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="64x64" href="favicon-64x64.png">
    <link rel="icon" type="image/png" sizes="128x128" href="favicon-128x128.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <!-- Android Chrome Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Budget Tracker - Smart Money Management">
    <meta property="og:description" content="Smart money management with budgets and goals">
    <meta property="og:image" content="android-chrome-512x512.png">
    <meta property="og:url" content="">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Budget Tracker - Smart Money Management">
    <meta name="twitter:description" content="Smart money management with budgets and goals">
    <meta name="twitter:image" content="android-chrome-512x512.png">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Budget Tracker">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">    
    <!-- Chart.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #4F46E5;
            --primary-light: #6366F1;
            --primary-dark: #3730A3;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="dark"] {
            --gray-50: #0F172A;
            --gray-100: #1E293B;
            --gray-200: #334155;
            --gray-300: #475569;
            --gray-400: #64748B;
            --gray-500: #94A3B8;
            --gray-600: #CBD5E1;
            --gray-700: #E2E8F0;
            --gray-800: #F1F5F9;
            --gray-900: #F8FAFC;
            --primary: #6366F1;
            --primary-light: #818CF8;
            --primary-dark: #4F46E5;
            --success: #22C55E;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Rounded', system-ui, sans-serif;
            background: var(--gray-50);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            padding-bottom: 100px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-top: 20px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 0; /* Align with container edge */
        }
        
        .logo {
            height: 26px; /* Increased from 13px to 26px (2x bigger) */
            width: auto;
            transition: opacity 0.3s ease;
        }
        
        .header-text h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }
        
        .header-text p {
            color: var(--gray-500);
            font-size: 14px;
        }
        
        .header-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .icon-btn {
            background: var(--gray-100);
            border: none;
            border-radius: 12px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 18px;
            color: var(--gray-600);
        }
        
        .icon-btn:hover {
            background: var(--gray-200);
            transform: translateY(-1px);
        }
        
        .icon-btn:active {
            transform: translateY(0);
        }
        
        .balance-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 20px;
            padding: 32px;
            color: white;
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }
        
        .balance-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 8px;
        }
        
        .balance-info {
            width: 100%;
        }
        
        .balance-amount {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .balance-label {
            opacity: 0.9;
            font-size: 14px;
            margin-bottom: 24px;
        }
        
        .balance-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .balance-item {
            text-align: left;
        }
        
        .balance-item-amount {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .balance-item-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .charts-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }
        
        .chart-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            width: 100%;
        }
        
        .chart-header {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 12px;
            text-align: left;
        }
        
        .chart-content {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 16px;
            width: 100%;
        }
        
        .chart-canvas {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
        }
        
        .chart-canvas canvas {
            width: 100% !important;
            height: 100% !important;
            filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.3));
        }
        
        .chart-legend-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            align-items: flex-end;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 6px 12px;
            width: 100%;
            max-width: 280px;
            max-height: 120px;
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height 0.3s ease;
        }
        
        .legend-grid.expanded {
            max-height: 200px;
        }
        
        .legend-grid::-webkit-scrollbar {
            width: 4px;
        }
        
        .legend-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }
        
        .legend-grid::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
        
        .legend-grid::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Mobile responsive - single column on narrow screens */
        @media (max-width: 480px) {
            .legend-grid {
                grid-template-columns: 1fr;
                max-width: 200px;
            }
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
            transition: opacity 0.3s ease;
        }
        
        .legend-item.legend-hidden {
            display: none;
        }
        
        .legend-item.legend-visible {
            display: flex;
        }
        
        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .expand-icon {
            font-size: 10px;
            transition: transform 0.2s ease;
        }
        
        .expand-icon.rotated {
            transform: rotate(180deg);
        }
        
        .chart-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .budget-dropdown-container {
            position: relative;
        }
        
        .budget-dropdown-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            min-width: 100px;
        }
        
        .budget-dropdown-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .dropdown-arrow {
            font-size: 10px;
            transition: transform 0.2s ease;
        }
        
        .dropdown-arrow.rotated {
            transform: rotate(180deg);
        }
        
        .budget-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            min-width: 140px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            margin-top: 4px;
            backdrop-filter: blur(10px);
        }
        
        .budget-dropdown-menu.show {
            display: block;
        }
        
        .budget-dropdown-item {
            padding: 8px 12px;
            font-size: 12px;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .budget-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .budget-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .budget-dropdown-item.active {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary);
            font-weight: 500;
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--gray-100);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        
        [data-theme="dark"] .stat-card {
            background: var(--gray-200);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--gray-500);
        }
        
        .daily-limit-progress {
            width: 100%;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .daily-limit-progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .set-limit-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 4px;
            transition: all 0.2s ease;
        }
        
        .set-limit-btn:hover {
            background: var(--primary-dark);
        }
        
        .navigation {
            background: var(--gray-100);
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 4px;
        }
        
        [data-theme="dark"] .navigation {
            background: var(--gray-200);
        }
        
        .nav-tab {
            flex: 1;
            background: transparent;
            border: none;
            border-radius: 16px;
            padding: 12px 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .nav-tab:hover:not(.active) {
            background: var(--gray-200);
        }
        
        [data-theme="dark"] .nav-tab:hover:not(.active) {
            background: var(--gray-300);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: var(--gray-100);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }
        
        [data-theme="dark"] .card {
            background: var(--gray-200);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .add-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .add-btn:hover {
            background: var(--primary-dark);
        }
        
        .transaction-item, .budget-item, .goal-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-200);
        }
        
        [data-theme="dark"] .transaction-item,
        [data-theme="dark"] .budget-item,
        [data-theme="dark"] .goal-item {
            border-bottom-color: var(--gray-300);
        }
        
        .transaction-item:last-child, .budget-item:last-child, .goal-item:last-child {
            border-bottom: none;
        }
        
        .transaction-left, .budget-left, .goal-left {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .transaction-icon, .budget-icon, .goal-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
        }
        
        .transaction-info, .budget-info, .goal-info {
            flex: 1;
        }
        
        .transaction-description, .budget-category, .goal-name {
            font-weight: 500;
            color: var(--gray-900);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
        }
        
        .transaction-meta, .budget-meta, .goal-meta {
            font-size: 12px;
            color: var(--gray-500);
        }
        
        .transaction-amount {
            font-weight: 600;
            font-size: 16px;
        }
        
        .transaction-amount.income {
            color: var(--success);
        }
        
        .transaction-amount.expense {
            color: var(--danger);
        }
        
        .transaction-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .budget-progress, .goal-progress {
            flex: 1;
            margin: 0 16px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        
        [data-theme="dark"] .progress-bar {
            background: var(--gray-300);
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 12px;
            color: var(--gray-600);
        }
        
        .budget-amount, .goal-amount {
            text-align: right;
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .insights-scroll-container {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 8px;
            margin-bottom: 8px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        .insights-scroll-container::-webkit-scrollbar {
            height: 6px;
        }
        
        .insights-scroll-container::-webkit-scrollbar-track {
            background: var(--gray-200);
            border-radius: 3px;
        }
        
        .insights-scroll-container::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 3px;
        }
        
        .insights-scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }
        
        [data-theme="dark"] .insights-scroll-container::-webkit-scrollbar-track {
            background: var(--gray-300);
        }
        
        [data-theme="dark"] .insights-scroll-container::-webkit-scrollbar-thumb {
            background: var(--gray-500);
        }
        
        [data-theme="dark"] .insights-scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--gray-600);
        }
        
        .chart-container {
            background: var(--gray-100);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            flex-shrink: 0;
            min-width: 300px;
            width: 300px;
        }
        
        .insights-scroll-container .chart-container {
            margin-bottom: 0;
        }
        
        [data-theme="dark"] .chart-container {
            background: var(--gray-200);
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 16px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.2s ease;
            z-index: 1000;
        }
        
        .fab:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }
        
        .fab:active {
            transform: scale(1.05);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--gray-50);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 16px 24px 24px;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        [data-theme="dark"] .modal-footer {
            border-top-color: var(--gray-300);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 24px 24px 0;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray-400);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }
        
        [data-theme="dark"] .close-btn:hover {
            background: var(--gray-200);
        }
        
        .type-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .type-btn {
            flex: 1;
            background: var(--gray-100);
            border: none;
            border-radius: 12px;
            padding: 12px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        [data-theme="dark"] .type-btn {
            background: var(--gray-200);
        }
        
        .type-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .type-btn:hover:not(.active) {
            background: var(--gray-200);
        }
        
        [data-theme="dark"] .type-btn:hover:not(.active) {
            background: var(--gray-300);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: var(--gray-100);
            color: var(--gray-900);
        }
        
        .form-select {
            padding-right: 40px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
        }
        
        [data-theme="dark"] .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%94a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        }
        
        .daily-limit-input {
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        
        .daily-limit-input::-webkit-outer-spin-button,
        .daily-limit-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .form-group {
            position: relative;
        }
        

        
        [data-theme="dark"] .form-input,
        [data-theme="dark"] .form-select {
            background: var(--gray-200);
            border-color: var(--gray-300);
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .form-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-full {
            width: 100%;
        }
        
        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }
        
        .btn-secondary:hover {
            background: var(--gray-300);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 16px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 16px;
            background: var(--gray-100);
        }
        
        [data-theme="dark"] .search-input {
            background: var(--gray-200);
            border-color: var(--gray-300);
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }
        
        .filter-chips {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .filter-chip {
            background: var(--gray-100);
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        [data-theme="dark"] .filter-chip {
            background: var(--gray-200);
        }
        
        .filter-chip.active {
            background: var(--primary);
            color: white;
        }
        
        .filter-chip:hover:not(.active) {
            background: var(--gray-200);
        }
        
        [data-theme="dark"] .filter-chip:hover:not(.active) {
            background: var(--gray-300);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 3000;
            max-width: 300px;
            font-weight: 500;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-500);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .empty-state-subtext {
            font-size: 14px;
            opacity: 0.8;
        }
        
        #recurringOptions {
            display: none;
            margin-top: 12px;
        }
        
        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s ease;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .menu-modal-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 0 24px 24px 24px;
        }
        
        .menu-btn {
            background: var(--gray-100);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
            color: var(--gray-700);
        }
        
        [data-theme="dark"] .menu-btn {
            background: var(--gray-200);
            border-color: var(--gray-300);
        }
        
        .menu-btn:hover {
            border-color: var(--primary);
            background: var(--gray-50);
        }
        
        [data-theme="dark"] .menu-btn:hover {
            background: var(--gray-100);
        }
        
        .file-input {
            display: none;
        }
        
        .budget-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        
        [data-theme="dark"] .budget-progress-bar {
            background: var(--gray-300);
        }
        
        .budget-progress-bar.over-budget {
            background: var(--danger);
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .goal-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        
        [data-theme="dark"] .goal-progress-bar {
            background: var(--gray-300);
        }
        
        .goal-percentage {
            font-size: 12px;
            color: var(--gray-600);
        }
        
        .achievement-badge {
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
            white-space: nowrap;
            display: inline-block;
        }
        
        .over-budget-pill {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
            font-weight: 500;
            display: inline-block;
        }
        
        .recurring-indicator {
            background: var(--info);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
            
            .balance-amount {
                font-size: 28px;
            }
            
            .balance-content {
                gap: 20px;
            }
            
            .chart-canvas {
                width: 70px;
                height: 70px;
            }
            
            .legend-item {
                font-size: 12px;
            }
            
            .quick-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .chart-container {
                min-width: 280px;
                width: 280px;
                padding: 16px;
            }
            
            .insights-scroll-container {
                gap: 12px;
            }
        }
        
        /* Confetti (lightweight, 2–3s) */
        .confetti {
            position: fixed;
            top: -10px;
            width: 8px;
            height: 12px;
            border-radius: 1px;
            opacity: .95;
            pointer-events: none;
            will-change: transform, opacity;
            animation: confetti-fall var(--cfdur, 2.6s) linear forwards;
        }
        @keyframes confetti-fall {
            to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        /* Accessibility: honor user motion prefs */
        @media (prefers-reduced-motion: reduce) {
            .confetti { display: none !important; animation: none !important; }
        }
    </style>

<style id="hide-contrib-options">
  /* Surgical hide: only the two specific checkbox rows in the Add Transaction modal */
  .form-checkbox:has(#contributeSavings),
  .form-checkbox:has(#contributeDebt) { display: none !important; }
</style>
<script id="hide-contrib-options-fallback">
  // Fallback for browsers without :has()
  document.addEventListener('DOMContentLoaded', function () {
    ['contributeSavings','contributeDebt'].forEach(function(id){
      var el = document.getElementById(id);
      if (el) {
        var row = el.closest('.form-checkbox');
        if (row) row.style.display = 'none';
      }
    });
  });
</script>

</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <img id="appLogo" class="logo" src="" alt="Budget Tracker">
            </div>
            <div class="header-right">
                <button class="icon-btn" onclick="showSearch()">🔍</button>
                <button class="icon-btn" onclick="showMenu()">⋯</button>
                <button class="icon-btn theme-toggle" onclick="toggleTheme()">🌙</button>
            </div>
        </div>
        
        <!-- Balance Card -->
        <div class="balance-card">
            <div class="balance-content">
                <!-- Balance Info Section -->
                <div class="balance-info">
                    <div class="balance-amount" id="balance">$0.00</div>
                    <div class="balance-label">Current Balance</div>
                    <div class="balance-details">
                        <div class="balance-item">
                            <div class="balance-item-amount" id="totalIncome">$0.00</div>
                            <div class="balance-item-label">Income</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-item-amount" id="totalExpenses">$0.00</div>
                            <div class="balance-item-label">Expenses</div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Section -->
                <div class="charts-section">
                    <!-- Expenses Chart -->
                    <div class="chart-section">
                        <div class="chart-header-container">
                            <div class="chart-header">Expenses</div>
                            <div class="expense-expand-container">
                                <button class="budget-dropdown-btn" id="expenseLegendExpandBtn" onclick="toggleExpenseLegend()">
                                    <span id="expenseLegendExpandText">Show More</span>
                                    <span class="dropdown-arrow" id="expenseLegendExpandIcon">▼</span>
                                </button>
                            </div>
                        </div>
                        <div class="chart-content">
                            <div class="chart-canvas">
                                <canvas id="expenseChart"></canvas>
                            </div>
                            <div class="chart-legend-container" id="expenseLegendContainer">
                                <div class="legend-grid" id="expenseLegendGrid">
                                    <div class="legend-item">
                                        <div class="legend-dot" style="background-color: #00FF88;"></div>
                                        <span>Food & Dining</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-dot" style="background-color: #FF4757;"></div>
                                        <span>Transportation</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-dot" style="background-color: #FFA726;"></div>
                                        <span>Shopping</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-dot" style="background-color: #42A5F5;"></div>
                                        <span>Entertainment</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-dot" style="background-color: #AB47BC;"></div>
                                        <span>Healthcare</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-dot" style="background-color: #66BB6A;"></div>
                                        <span>Utilities</span>
                                    </div>
                                    <div class="legend-item legend-hidden">
                                        <div class="legend-dot" style="background-color: #FF7043;"></div>
                                        <span>Education</span>
                                    </div>
                                    <div class="legend-item legend-hidden">
                                        <div class="legend-dot" style="background-color: #FFCA28;"></div>
                                        <span>Insurance</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Budget Chart -->
                    <div class="chart-section">
                        <div class="chart-header-container">
                            <div class="chart-header">Budget</div>
                            <div class="budget-dropdown-container" id="budgetDropdownContainer" style="display: none;">
                                <button class="budget-dropdown-btn" id="budgetDropdownBtn" onclick="toggleBudgetDropdown()">
                                    <span id="selectedBudgetName">All Budgets</span>
                                    <span class="dropdown-arrow">▼</span>
                                </button>
                                <div class="budget-dropdown-menu" id="budgetDropdownMenu">
                                    <div class="budget-dropdown-item active" onclick="selectBudget('all')">All Budgets</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-content">
                            <div class="chart-canvas">
                                <canvas id="budgetChart"></canvas>
                            </div>
                            <div class="chart-legend-container">
                                <div class="legend-item">
                                    <div class="legend-dot" style="background-color: #00FF88;"></div>
                                    <span>Used</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot" style="background-color: #E5E7EB;"></div>
                                    <span>Remaining</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-value" id="monthlySpending">$0.00</div>
                <div class="stat-label">Expenses This Month</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="goalsProgress">0%</div>
                <div class="stat-label">Goals Progress</div>
            </div>
            <div class="stat-card" id="dailyLimitCard" onclick="showModal('settingsModal')">
                <div class="stat-value" id="dailyLimitValue">Set Daily Limit</div>
                <div class="stat-label">Set Daily Limit ✏️</div>
                <div id="dailyLimitProgress" class="daily-limit-progress" style="display: none;">
                    <div id="dailyLimitProgressBar" class="daily-limit-progress-bar"></div>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-tab active" onclick="switchTab('overview')">Overview</button>
            <button class="nav-tab" onclick="switchTab('budgets')">Budgets</button>
            <button class="nav-tab" onclick="switchTab('goals')">Goals</button>
            <button class="nav-tab" onclick="switchTab('insights')">Insights</button>
        </div>
        
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Recent Transactions</h3>
                    <button class="add-btn" onclick="showTransactionModal()">+ Add</button>
                </div>
                <div id="transactionsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">💳</div>
                        <div class="empty-state-text">No transactions yet</div>
                        <div class="empty-state-subtext">Add your first transaction to get started</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Budgets Tab -->
        <div id="budgets" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Budget Overview</h3>
                </div>
                <div class="balance-details">
                    <div class="balance-item">
                        <div class="balance-item-amount" id="totalBudgetAmount">$0.00</div>
                        <div class="balance-item-label">Total Budget</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-item-amount" id="totalBudgetSpent">$0.00</div>
                        <div class="balance-item-label">Spent</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-item-amount" id="totalBudgetRemaining">$0.00</div>
                        <div class="balance-item-label">Remaining</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Category Budgets</h3>
                    <button class="add-btn" onclick="showBudgetModal()">+ Add</button>
                </div>
                <div id="budgetsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <div class="empty-state-text">No budgets set</div>
                        <div class="empty-state-subtext">Create budgets to track your spending</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Goals Tab -->
        <div id="goals" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Savings Goals</h3>
                    <button class="add-btn" onclick="showGoalModal()">+ Add</button>
                </div>
                <div id="goalsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">🎯</div>
                        <div class="empty-state-text">No goals set</div>
                        <div class="empty-state-subtext">Set savings goals to track your progress</div>
                    </div>
                </div>
            </div>
            
            <!-- Debt Goals Section -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Debt Goals</h3>
                    <button class="add-btn" onclick="showDebtModal()">+ Add</button>
                </div>
                <div id="debtsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">💳</div>
                        <div class="empty-state-text">No debts set</div>
                        <div class="empty-state-subtext">Add debts to track your payoff progress</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Insights Tab -->
        <div id="insights" class="tab-content">
            <div class="insights-scroll-container">
                <div class="chart-container">
                    <h3 class="chart-title">Spending Overview</h3>
                    <div class="chart-wrapper">
                        <canvas id="dashboardChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">Budget vs Spending</h3>
                    <div class="chart-wrapper">
                        <canvas id="budgetOverviewChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">Monthly Overview</h3>
                    <div class="chart-wrapper">
                        <canvas id="monthlyOverviewChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FAB -->
        <button class="fab" onclick="showTransactionModal()">+</button>
    </div>
    
    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Transaction</h3>
                <button class="close-btn" onclick="closeModal('transactionModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="type-selector">
                    <button id="incomeBtn" class="type-btn" onclick="setType('income')">Income</button>
                    <button id="expenseBtn" class="type-btn active" onclick="setType('expense')">Expense</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="description">Description</label>
                    <input type="text" id="description" class="form-input" placeholder="Enter description">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="amount">Amount</label>
                    <input type="number" id="amount" class="form-input" placeholder="0.00" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="category">Category</label>
                    <select id="category" class="form-select">
                        <option value="">Select category</option>
                    </select>
                </div>
                
                <div class="form-checkbox">
                    <input type="checkbox" id="contributeSavings">
                    <label for="contributeSavings">Contribute to savings</label>
                </div>
                
                <div id="savingsOptions" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="savingsGoal">Savings Goal</label>
                        <select id="savingsGoal" class="form-select">
                            <option value="">Select savings goal</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="savingsAmount">Savings Amount</label>
                        <input type="number" id="savingsAmount" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                </div>
                
                <div class="form-checkbox">
                    <input type="checkbox" id="contributeDebt">
                    <label for="contributeDebt">Contribute to debt</label>
                </div>
                
                <div id="debtOptions" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="debtGoal">Debt Goal</label>
                        <select id="debtGoal" class="form-select">
                            <option value="">Select debt goal</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="debtAmount">Debt Payment</label>
                        <input type="number" id="debtPayment" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                </div>
                
                <div class="form-checkbox">
                    <input type="checkbox" id="recurring">
                    <label for="recurring">Recurring transaction</label>
                </div>
                
                <div id="recurringOptions" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="frequency">Frequency</label>
                        <select id="frequency" class="form-select">
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-primary btn-full" onclick="addTransaction()">Add Transaction</button>
            </div>
        </div>
    </div>
    
    <!-- Budget Modal -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Budget</h3>
                <button class="close-btn" onclick="closeModal('budgetModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="budgetCategory">Category</label>
                    <select id="budgetCategory" class="form-select">
                        <option value="">Select category</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="budgetAmount">Monthly Budget</label>
                    <input type="number" id="budgetAmount" class="form-input" placeholder="0.00" step="0.01">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-primary btn-full" onclick="addBudget()">Create Budget</button>
            </div>
        </div>
    </div>
    
    <!-- Goal Modal -->
    <div id="goalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Goal</h3>
                <button class="close-btn" onclick="closeModal('goalModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="goalName">Goal Name</label>
                    <input type="text" id="goalName" class="form-input" placeholder="Enter goal name">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="goalTarget">Target Amount</label>
                    <input type="number" id="goalTarget" class="form-input" placeholder="0.00" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="goalCurrent">Current Amount</label>
                    <input type="number" id="goalCurrent" class="form-input" placeholder="0.00" step="0.01" value="0">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-primary btn-full" onclick="addGoal()">Create Goal</button>
            </div>
        </div>
    </div>
    
    <!-- Debt Modal -->
    <div id="debtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Debt</h3>
                <button class="close-btn" onclick="closeModal('debtModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="debtName">Debt Name</label>
                    <input type="text" id="debtName" class="form-input" placeholder="Enter debt name">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="debtAmount">Total Amount</label>
                    <input type="number" id="debtAmount" class="form-input" placeholder="0.00" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="debtDueDate">Due Date</label>
                    <input type="date" id="debtDueDate" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="debtDescription">Description</label>
                    <textarea id="debtDescription" class="form-input" placeholder="Enter debt description" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="debtPaid">Amount Paid</label>
                    <input type="number" id="debtPaid" class="form-input" placeholder="0.00" step="0.01" value="0">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-primary btn-full" onclick="addDebt()">Create Debt</button>
            </div>
        </div>
    </div>
    
    <!-- Contribute Funds Modal -->
    <div id="contributeFundsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Contribute to Goal</h3>
                <button class="close-btn" onclick="closeModal('contributeFundsModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="contributeGoalName">Goal</label>
                    <input type="text" id="contributeGoalName" class="form-input" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="contributeAmount">Contribution Amount</label>
                    <input type="number" id="contributeAmount" class="form-input" placeholder="0.00" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="contributeNote">Note (Optional)</label>
                    <input type="text" id="contributeNote" class="form-input" placeholder="Enter a note for this contribution">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-primary btn-full" onclick="contributeToGoal()">Add Contribution</button>
            </div>
        </div>
    </div>
    
    
    <!-- Contribute to Debt Modal (additive; mirrors existing modal styles) -->
    <div id="contributeDebtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Contribute to Debt</h3>
                <button class="close-btn" onclick="closeModal('contributeDebtModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="contributeDebtName">Debt</label>
                    <input type="text" id="contributeDebtName" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" for="contributeDebtAmount">Payment Amount</label>
                    <input type="number" id="contributeDebtAmount" class="form-input" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label" for="contributeDebtNote">Note (optional)</label>
                    <input type="text" id="contributeDebtNote" class="form-input" placeholder="Enter a note for this payment">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-full" onclick="contributeToDebt()">Add Payment</button>
            </div>
        </div>
    </div>

<!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Set Limit</h2>
                <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-checkbox">
                    <input type="checkbox" id="enableRoundups">
                    <label for="enableRoundups">Enable roundups</label>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="roundupGoal">Roundup target goal</label>
                    <select id="roundupGoal" class="form-select">
                        <option value="">Select goal</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="dailyLimit">Daily Limit ($/day)</label>
                    <input type="number" id="dailyLimit" class="form-input" placeholder="0.00" step="0.01">
                </div>
            </div>
            
            <div class="modal-footer">
                <div style="display: flex; gap: 10px; width: 100%;">
                    <button type="button" class="btn btn-secondary" onclick="resetDailyLimit()">Reset Daily Limit</button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Menu Modal -->
    <div id="menuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Menu</h3>
                <button class="close-btn" onclick="closeModal('menuModal')">&times;</button>
            </div>
            
            <div class="menu-modal-content">
                <button class="menu-btn" onclick="exportJSON()">📄 Export JSON</button>
                <button class="menu-btn" onclick="exportCSV()">📊 Export CSV</button>
                <button class="menu-btn" onclick="document.getElementById('importFile').click()">📥 Import JSON</button>
                <button class="menu-btn" onclick="resetAllData()">🔄 Reset</button>
            </div>
            
            <input type="file" id="importFile" class="file-input" accept="application/json" onchange="importJSON(event)">
        </div>
    </div>
    
    <!-- Search Modal -->
    <div id="searchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Search Transactions</h3>
                <button class="close-btn" onclick="closeModal('searchModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="search-box">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search transactions..." oninput="filterTransactions()">
                </div>
                
                <div class="filter-chips">
                    <button class="filter-chip active" onclick="filterByType('all')">All</button>
                    <button class="filter-chip" onclick="filterByType('income')">Income</button>
                    <button class="filter-chip" onclick="filterByType('expense')">Expense</button>
                </div>
                
                <div id="searchResults"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let transactions = [];
        let budgets = [];
        let goals = [];
        let debts = [];
        let selectedDebtIdForContribution = null;  // added: tracks which debt we're contributing to
        let settings = {
            enableRoundups: false,
            roundupGoal: '',
            dailyLimit: 0
        };
        let charts = {};
        let currentTransactionType = 'expense';
        
        // Categories
        const expenseCategories = [
            'Food & Dining', 'Transportation', 'Shopping', 'Entertainment',
            'Bills & Utilities', 'Healthcare', 'Education', 'Travel',
            'Personal Care', 'Gifts & Donations', 'Other'
        ];
        
        const incomeCategories = [
            'Salary', 'Freelance', 'Business', 'Investments',
            'Rental Income', 'Gifts', 'Other'
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateCategoryOptions();
            initializeCharts();
            updateDashboard();
            
            // Initialize logo based on current theme
            const currentTheme = document.body.getAttribute("data-theme") || "light";
            updateLogo(currentTheme);
            
            // Set up recurring checkbox handler
            document.getElementById("recurring").addEventListener("change", toggleRecurringOptions);
            
            // Set up savings contribution checkbox handler
            document.getElementById("contributeSavings").addEventListener("change", toggleSavingsOptions);
            
            // Set up debt contribution checkbox handler
            document.getElementById("contributeDebt").addEventListener("change", toggleDebtOptions);

            // Initialize expense legend to be expanded by default
            document.getElementById("expenseLegendGrid").classList.add("expanded");
            document.getElementById("expenseLegendExpandText").textContent = "Show Less";
            document.getElementById("expenseLegendExpandIcon").classList.add("rotated");
        });

        // Logo management
        function updateLogo(theme) {
            const logo = document.getElementById('appLogo');
            if (theme === 'dark') {
                logo.src = 'Logo-Dark.png'; // Dark logo for dark theme
            } else {
                logo.src = 'Logo-Light.png'; // Light logo for light theme
            }
        }

        // Theme management
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update theme toggle icon
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.textContent = newTheme === 'dark' ? '☀️' : '🌙';
            
            // Update logo for new theme
            updateLogo(newTheme);
            
            // Reinitialize charts with new theme
            setTimeout(() => {
                initializeCharts();
                updateCharts();
            }, 100);
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        if (savedTheme === 'dark') {
            document.querySelector('.theme-toggle').textContent = '☀️';
        }
        
        // Initialize logo based on saved theme
        updateLogo(savedTheme);

        // Category management
        function updateCategoryOptions() {
            const categorySelect = document.getElementById('category');
            const budgetCategorySelect = document.getElementById('budgetCategory');
            
            const categories = currentTransactionType === 'expense' ? expenseCategories : incomeCategories;
            
            categorySelect.innerHTML = '<option value="">Select category</option>';
            categories.forEach(category => {
                categorySelect.innerHTML += `<option value="${category}">${category}</option>`;
            });
            
            budgetCategorySelect.innerHTML = '<option value="">Select category</option>';
            expenseCategories.forEach(category => {
                budgetCategorySelect.innerHTML += `<option value="${category}">${category}</option>`;
            });
            
            // Update savings goals dropdown
            updateSavingsGoalsOptions();
        }

        function updateSavingsGoalsOptions() {
            const savingsGoalSelect = document.getElementById('savingsGoal');
            
            savingsGoalSelect.innerHTML = '<option value="">Select savings goal</option>';
            goals.forEach(goal => {
                savingsGoalSelect.innerHTML += `<option value="${goal.id}">${goal.name}</option>`;
            });
        }

        // Transaction type management
        function setType(type) {
            currentTransactionType = type;
            
            document.getElementById('incomeBtn').classList.toggle('active', type === 'income');
            document.getElementById('expenseBtn').classList.toggle('active', type === 'expense');
            
            // Show/hide savings contribution section based on transaction type
            const savingsCheckbox = document.getElementById('contributeSavings');
            const savingsSection = savingsCheckbox.closest('.form-checkbox');
            const savingsOptions = document.getElementById('savingsOptions');
            
            // Show/hide debt contribution section based on transaction type
            const debtCheckbox = document.getElementById('contributeDebt');
            const debtSection = debtCheckbox.closest('.form-checkbox');
            const debtOptions = document.getElementById('debtOptions');
            
            if (type === 'income') {
                savingsSection.style.display = 'block';
                debtSection.style.display = 'block';
            } else {
                savingsSection.style.display = 'none';
                debtSection.style.display = 'none';
                // Reset savings options when switching to expense
                savingsCheckbox.checked = false;
                savingsOptions.style.display = 'none';
                // Reset debt options when switching to expense
                debtCheckbox.checked = false;
                debtOptions.style.display = 'none';
            }
            
            updateCategoryOptions();
        }

        // Modal management
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            // Reset forms
            if (modalId === 'transactionModal') {
                document.getElementById('description').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('category').value = '';
                document.getElementById('recurring').checked = false;
                document.getElementById('recurringOptions').style.display = 'none';
                document.getElementById('contributeSavings').checked = false;
                document.getElementById('savingsOptions').style.display = 'none';
                document.getElementById('savingsGoal').value = '';
                document.getElementById('savingsAmount').value = '';
                setType('expense');
            }
        }

        function showTransactionModal() {
            showModal('transactionModal');
            // Initialize the modal with expense type (default) and hide savings section
            setType('expense');
        }

        function showBudgetModal() {
            showModal('budgetModal');
        }

        function showGoalModal() {
            showModal('goalModal');
        }

        function resetAllData() {
            // Show confirmation using alert first, then proceed
            const userConfirmed = window.confirm('Are you sure you want to reset all data? This will permanently delete all transactions, goals, budgets, and settings. This action cannot be undone.');
            
            if (userConfirmed) {
                // Clear all localStorage data
                localStorage.removeItem('transactions');
                localStorage.removeItem('goals');
                localStorage.removeItem('budgets');
                localStorage.removeItem('settings');
                
                // Reset all global variables to default state
                transactions = [];
                goals = [];
                debts = [];
                budgets = [];
                settings = {
                    enableRoundups: false,
                    roundupGoal: '',
                    dailyLimit: 0
                };
                
                // Update all displays
                updateTransactionsList();
                updateGoalsList();
                updateBudgetsList();
                updateDashboard();
                updateBalanceCard();
                updateQuickStats();
                updateCategoryOptions();
                
                // Close menu modal
                closeModal('menuModal');
                
                // Show confirmation
                showNotification('All data has been reset to default state');
            }
        }

        function showMenu() {
            showModal('menuModal');
        }

        function showSearch() {
            showModal('searchModal');
            filterTransactions();
        }

        // Tab management
        function switchTab(tabName) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        // Transaction management
        function addTransaction() {
            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const isRecurring = document.getElementById('recurring').checked;
            const frequency = document.getElementById('frequency').value;
            
            if (!description || !amount || !category) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            const transaction = {
                id: Date.now(),
                description,
                amount: currentTransactionType === 'expense' ? -Math.abs(amount) : Math.abs(amount),
                category,
                type: currentTransactionType,
                date: new Date().toISOString(),
                isRecurring,
                frequency: isRecurring ? frequency : null
            };
            
            transactions.unshift(transaction);
            
            // Handle savings contributions
            if (currentTransactionType === 'income') {
                const contributeSavings = document.getElementById('contributeSavings').checked;
                if (contributeSavings) {
                    const savingsGoalId = document.getElementById('savingsGoal').value;
                    const savingsAmount = parseFloat(document.getElementById('savingsAmount').value);
                    
                    if (savingsGoalId && savingsAmount > 0) {
                        const goal = goals.find(g => g.id == savingsGoalId);
                        if (goal) {
                            goal.current = Math.min(goal.current + savingsAmount, goal.target);
                            showNotification(`Added $${savingsAmount.toFixed(2)} to ${goal.name}`);
                        }
                    }
                }
                
                // Handle debt contributions
                const contributeDebt = document.getElementById('contributeDebt').checked;
                if (contributeDebt) {
                    const debtGoalId = document.getElementById('debtGoal').value;
                    const debtPayment = parseFloat(document.getElementById('debtPayment').value);
                    
                    if (debtGoalId && debtPayment > 0) {
                        const debt = debts.find(d => d.id == debtGoalId);
                        if (debt) {
                            debt.paid = Math.min(debt.paid + debtPayment, debt.amount);
                            showNotification(`Added $${debtPayment.toFixed(2)} payment to ${debt.name}`);
                        }
                    }
                }
            }
            
            // Handle roundups
            if (settings.enableRoundups && currentTransactionType === 'expense' && settings.roundupGoal) {
                const roundup = Math.ceil(amount) - amount;
                if (roundup > 0) {
                    const goal = goals.find(g => g.name === settings.roundupGoal);
                    if (goal) {
                        goal.current = Math.min(goal.current + roundup, goal.target);
                        showNotification(`Rounded up $${roundup.toFixed(2)} to ${goal.name}`);
                    }
                }
            }
            
            saveData();
            updateDashboard();
            closeModal('transactionModal');
            showNotification('Transaction added successfully');
        }

        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            updateDashboard();
            showNotification('Transaction deleted');
        }

        // Budget management
        function addBudget() {
            const category = document.getElementById('budgetCategory').value;
            const amount = parseFloat(document.getElementById('budgetAmount').value);
            
            if (!category || !amount) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            // Check if budget already exists for this category
            if (budgets.find(b => b.category === category)) {
                showNotification('Budget already exists for this category', 'error');
                return;
            }
            
            const budget = {
                id: Date.now(),
                category,
                amount,
                spent: 0
            };
            
            budgets.push(budget);
            saveData();
            updateDashboard();
            closeModal('budgetModal');
            showNotification('Budget created successfully');
        }

        function deleteBudget(id) {
            budgets = budgets.filter(b => b.id !== id);
            saveData();
            updateDashboard();
            showNotification('Budget deleted');
        }

        // Goal management
        function addGoal() {
            const name = document.getElementById('goalName').value;
            const target = parseFloat(document.getElementById('goalTarget').value);
            const current = parseFloat(document.getElementById('goalCurrent').value) || 0;
            
            if (!name || !target) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            const goal = {
                id: Date.now(),
                name,
                target,
                current
            };
            
            goals.push(goal);
            saveData();
            updateDashboard();
            closeModal('goalModal');
            showNotification('Goal created successfully');
        }

        function deleteGoal(id) {
            goals = goals.filter(g => g.id !== id);
            saveData();
            updateDashboard();
            showNotification('Goal deleted');
        }

        function updateGoalProgress(id, amount) {
            const goal = goals.find(g => g.id === id);
            if (goal) {
                goal.current = Math.min(goal.current + amount, goal.target);
                saveData();
                updateDashboard();
                showNotification('Goal updated');
            }
        }

        // Debt management
        function showDebtModal() {
            document.getElementById('debtName').value = '';
            document.getElementById('debtAmount').value = '';
            document.getElementById('debtDueDate').value = '';
            document.getElementById('debtDescription').value = '';
            document.getElementById('debtPaid').value = '0';
            showModal('debtModal');
        }

        function addDebt() {
            const name = document.getElementById('debtName').value.trim();
            const amount = parseFloat(document.getElementById('debtAmount').value);
            const dueDate = document.getElementById('debtDueDate').value;
            const description = document.getElementById('debtDescription').value.trim();
            const paid = parseFloat(document.getElementById('debtPaid').value) || 0;

            if (!name || !amount || amount <= 0) {
                showNotification('Please enter valid debt details', 'error');
                return;
            }

            const debt = {
                id: Date.now(),
                name: name,
                amount: amount,
                dueDate: dueDate,
                description: description,
                paid: Math.min(paid, amount)
            };

            debts.push(debt);
            saveData();
            updateDebtsList();
            closeModal('debtModal');
            showNotification('Debt added successfully');
        }

        function deleteDebt(id) {
            if (true) {
                debts = debts.filter(d => d.id !== id);
                saveData();
                updateDebtsList();
                showNotification('Debt deleted');
            }
        }

        function updateDebtProgress(id, amount) {
            const debt = debts.find(d => d.id === id);
            if (debt) {
                const wasCompleted = debt.paid >= debt.amount;
                debt.paid = Math.min(debt.paid + amount, debt.amount);
                const isNowCompleted = debt.paid >= debt.amount;
                
                saveData();
                updateDashboard();
                
                // Trigger confetti if debt was just completed
                if (!wasCompleted && isNowCompleted) {
                    setTimeout(() => {
                        if (typeof Confetti !== 'undefined') {
                            Confetti.burst(48);
                        }
                    }, 100);
                    showNotification('🎉 Debt paid off! Congratulations!');
                } else {
                    showNotification('Debt payment recorded');
                }
            }
        }

        // Settings management
function saveSettings() {
            settings.enableRoundups = document.getElementById('enableRoundups').checked;
            settings.roundupGoal = document.getElementById('roundupGoal').value;
            settings.dailyLimit = parseFloat(document.getElementById('dailyLimit').value) || 0;
            
            saveData();
            updateDashboard();
            closeModal('settingsModal');
            showNotification('Settings saved');
        }

        function resetDailyLimit() {
            // Reset all form fields to default state
            document.getElementById('enableRoundups').checked = false;
            document.getElementById('roundupGoal').value = '';
            document.getElementById('dailyLimit').value = '';
            
            // Reset settings object
            settings.dailyLimit = 0;
            settings.enableRoundups = false;
            settings.roundupGoal = '';
            
            // Remove from localStorage
            localStorage.removeItem("dailyLimit");
            localStorage.removeItem("enableRoundups");
            localStorage.removeItem("roundupGoal");
            
            // Update the card display to show default state
            updateDailyLimit();
            closeModal("settingsModal");
        }
        


        function updateGoalOptions() {
            const roundupGoalSelect = document.getElementById('roundupGoal');
            roundupGoalSelect.innerHTML = '<option value="">Select goal</option>';
            
            goals.forEach(goal => {
                roundupGoalSelect.innerHTML += `<option value="${goal.name}" ${settings.roundupGoal === goal.name ? 'selected' : ''}>${goal.name}</option>`;
            });
            
            // Update form values
            document.getElementById('enableRoundups').checked = settings.enableRoundups;
            document.getElementById('dailyLimit').value = settings.dailyLimit;
        }

        // Dashboard updates
        function updateDashboard() {
            updateBalanceCard();
            updateQuickStats();
            updateTransactionsList();
            updateBudgetsList();
            updateGoalsList();
            updateDebtsList();
            updateCharts();
        
            // Sync goals mini progress bar to the displayed percent
            (function(){
                var el = document.getElementById('goalsProgressValue');
                if (el) {
                    var m = el.textContent.match(/(\d+)%/);
                    if (m) updateGoalsProgressBar(parseInt(m[1],10));
                }
            })();
}

        function updateBalanceCard() {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            
            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            
            const balance = totalIncome - totalExpenses;
            
            document.getElementById('balance').textContent = formatCurrency(balance);
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
        }

        function updateQuickStats() {
            // Monthly spending
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlySpending = transactions
                .filter(t => {
                    const date = new Date(t.date);
                    return t.type === 'expense' && 
                           date.getMonth() === currentMonth && 
                           date.getFullYear() === currentYear;
                })
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            
            document.getElementById('monthlySpending').textContent = formatCurrency(monthlySpending);
            
            // Goals progress
            const totalGoalProgress = goals.length > 0 
                ? goals.reduce((sum, g) => sum + (g.current / g.target), 0) / goals.length * 100
                : 0;
            
            document.getElementById('goalsProgress').textContent = Math.round(totalGoalProgress) + '%';
            
            // Daily limit
            updateDailyLimit();
        }

        function updateDailyLimit() {
            const dailyLimitCard = document.getElementById('dailyLimitCard');
            const dailyLimitValue = document.getElementById('dailyLimitValue');
            const dailyLimitProgress = document.getElementById('dailyLimitProgress');
            const dailyLimitProgressBar = document.getElementById('dailyLimitProgressBar');
            
            if (settings.dailyLimit > 0) {
                const today = new Date().toDateString();
                const todaySpending = transactions
                    .filter(t => t.type === 'expense' && new Date(t.date).toDateString() === today)
                    .reduce((sum, t) => sum + Math.abs(t.amount), 0);
                
                const percentage = (todaySpending / settings.dailyLimit) * 100;
                
                dailyLimitValue.textContent = formatCurrency(todaySpending) + ' / ' + formatCurrency(settings.dailyLimit);
                dailyLimitProgress.style.display = 'block';
                dailyLimitProgressBar.style.width = Math.min(percentage, 100) + '%';
                
                if (percentage > 100) {
                    dailyLimitProgressBar.style.background = 'var(--danger)';
                } else if (percentage > 80) {
                    dailyLimitProgressBar.style.background = 'var(--warning)';
                } else {
                    dailyLimitProgressBar.style.background = 'var(--primary)';
                }
            } else {
                dailyLimitValue.textContent = 'Set Daily Limit';
                dailyLimitProgress.style.display = 'none';
            }
        }

        function updateTransactionsList() {
            const container = document.getElementById('transactionsList');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">💳</div>
                        <div class="empty-state-text">No transactions yet</div>
                        <div class="empty-state-subtext">Add your first transaction to get started</div>
                    </div>
                `;
                return;
            }
            
            const recentTransactions = transactions.slice(0, 10);
            
            container.innerHTML = recentTransactions.map(transaction => `
                <div class="transaction-item slide-in">
                    <div class="transaction-left">
                        <div class="transaction-icon" style="background: ${getIconBackground(transaction.category)}">
                            ${getIconForCategory(transaction.category)}
                        </div>
                        <div class="transaction-info">
                            <div class="transaction-description">${transaction.description}</div>
                            <div class="transaction-meta">
                                ${transaction.category} • ${formatDate(transaction.date)}
                                ${transaction.isRecurring ? '<span class="recurring-indicator">Recurring</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="transaction-right">
                        <div class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : ''}${formatCurrency(Math.abs(transaction.amount))}
                        </div>
                        <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">×</button>
                    </div>
                </div>
            `).join('');
        }

        function updateBudgetsList() {
            const container = document.getElementById('budgetsList');
            
            if (budgets.length === 0) {
                // When no budgets are set, show actual expense data
                const totalExpenses = transactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + Math.abs(t.amount), 0);
                
                // Update budget overview with actual data
                document.getElementById('totalBudgetAmount').textContent = formatCurrency(0);
                document.getElementById('totalBudgetSpent').textContent = formatCurrency(totalExpenses);
                document.getElementById('totalBudgetRemaining').textContent = formatCurrency(-totalExpenses);
                
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <div class="empty-state-text">No budgets set</div>
                        <div class="empty-state-subtext">Create budgets to track your spending</div>
                    </div>
                `;
                return;
            }
            
            // Calculate spent amounts
            budgets.forEach(budget => {
                budget.spent = transactions
                    .filter(t => t.type === 'expense' && t.category === budget.category)
                    .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            });
            
            // Update budget overview
            const totalBudget = budgets.reduce((sum, b) => sum + b.amount, 0);
            const totalSpent = budgets.reduce((sum, b) => sum + b.spent, 0);
            const totalRemaining = totalBudget - totalSpent;
            
            document.getElementById('totalBudgetAmount').textContent = formatCurrency(totalBudget);
            document.getElementById('totalBudgetSpent').textContent = formatCurrency(totalSpent);
            document.getElementById('totalBudgetRemaining').textContent = formatCurrency(totalRemaining);
            
            container.innerHTML = budgets.map(budget => {
                const percentage = (budget.spent / budget.amount) * 100;
                const isOverBudget = percentage > 100;
                
                return `
                    <div class="budget-item slide-in">
                        <div class="budget-left">
                            <div class="budget-icon" style="background: ${getIconBackground(budget.category)}">
                                ${getIconForCategory(budget.category)}
                            </div>
                            <div class="budget-info">
                                <div class="budget-category">${budget.category}</div>
                                <div class="budget-meta">
                                    ${formatCurrency(budget.spent)} of ${formatCurrency(budget.amount)}
                                    ${isOverBudget ? '<span class="over-budget-pill">Over Budget</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="budget-progress">
                            <div class="budget-progress-bar ${isOverBudget ? 'over-budget' : ''}">
                                <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%; background: ${isOverBudget ? 'var(--danger)' : 'var(--primary)'}"></div>
                            </div>
                            <div class="progress-text">${Math.round(percentage)}%</div>
                        </div>
                        <div class="budget-amount">
                            <button class="delete-btn" onclick="deleteBudget(${budget.id})">×</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateBudgetDropdown();
        }

        function updateDebtsList() {
            const container = document.getElementById('debtsList');
            
            if (debts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">💳</div>
                        <div class="empty-state-text">No debts set</div>
                        <div class="empty-state-subtext">Add debts to track your payoff progress</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = debts.map(debt => {
                const percentage = (debt.paid / debt.amount) * 100;
                const isCompleted = percentage >= 100;
                const remaining = debt.amount - debt.paid;
                const dueDate = debt.dueDate ? new Date(debt.dueDate).toLocaleDateString() : 'No due date';
                
                return `
                    <div class="savings-card goal-item slide-in" data-debt-id="debt-${debt.id}">
                        <div class="goal-left">
                            <div class="goal-icon" style="background: ${getIconBackground(debt.name)}">
                                💳
                            </div>
                            <div class="goal-info">
                                <div class="goal-header">
                                    <div class="goal-name">${debt.name}${isCompleted ? '<span class="achievement-badge">Paid Off!</span>' : ''}</div>
                                </div>
                                <div class="goal-meta">${formatCurrency(debt.paid)} of ${formatCurrency(debt.amount)}</div>
                            </div>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%; background: ${isCompleted ? 'var(--success)' : 'var(--primary)'}"></div>
                            </div>
                            <div class="goal-percentage">${Math.round(percentage)}%</div>
                        </div>
                        <div class="goal-amount">
                            <button class="add-savings-btn btn" style="background: var(--success); color: white; padding: 4px 8px; font-size: 12px; margin-right: 8px;" onclick="showContributeDebtModal(${debt.id})" >+ Add</button>
                            <button class="delete-btn" onclick="deleteDebt(${debt.id})">×</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateGoalsList() {
            const container = document.getElementById('goalsList');
            
            if (goals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🎯</div>
                        <div class="empty-state-text">No goals set</div>
                        <div class="empty-state-subtext">Set savings goals to track your progress</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = goals.map(goal => {
                const percentage = (goal.current / goal.target) * 100;
                const isCompleted = percentage >= 100;
                
                return `
                    <div class="savings-card goal-item slide-in" data-goal-id="goal-${goal.id}" data-current="${formatCurrency(goal.current)}" data-target="${formatCurrency(goal.target)}">
                        <div class="goal-left">
                            <div class="goal-icon" style="background: ${getIconBackground(goal.name)}">
                                🎯
                            </div>
                            <div class="goal-info">
                                <div class="goal-header">
                                    <div class="goal-name">${goal.name}${isCompleted ? '<span class="achievement-badge">Achieved!</span>' : ''}</div>
                                </div>
                                <div class="goal-meta">${formatCurrency(goal.current)} of ${formatCurrency(goal.target)}</div>
                            </div>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%; background: ${isCompleted ? 'var(--success)' : 'var(--primary)'}"></div>
                            </div>
                            <div class="goal-percentage">${Math.round(percentage)}%</div>
                        </div>
                        <div class="goal-amount">
                            <button class="add-savings-btn btn" style="background: var(--success); color: white; padding: 4px 8px; font-size: 12px; margin-right: 8px;" onclick="showContributeFundsModal(${goal.id})">+ Add</button>
                            <button class="delete-btn" onclick="deleteGoal(${goal.id})">×</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Chart initialization and management
        function initializeCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.log('Chart.js not loaded yet, retrying...');
                setTimeout(initializeCharts, 100);
                return;
            }
            
            console.log('Chart.js available, creating charts...');
            
            // Chart options
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#F1F5F9' : '#374151';
            
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            color: textColor,
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            };
            
            // Create expense chart with default data
            const expenseCtx = document.getElementById('expenseChart');
            if (expenseCtx) {
                charts.expense = new Chart(expenseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Food & Dining', 'Transportation', 'Shopping'],
                        datasets: [{
                            data: [40, 30, 30],
                            backgroundColor: ['#00FF88', '#FF4757', '#FFA726'],
                            borderWidth: 0,
                            cutout: '65%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
                console.log('Expense chart created');
            }

            // Create budget chart with default data
            const budgetCtx = document.getElementById('budgetChart');
            if (budgetCtx) {
                charts.budgetDonut = new Chart(budgetCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Used', 'Remaining'],
                        datasets: [{
                            data: [30, 70],
                            backgroundColor: ['#00FF88', '#E5E7EB'],
                            borderWidth: 0,
                            cutout: '65%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
                console.log('Budget chart created');
            }
            
            // Initialize legends with default data
            updateExpenseLegend(['Food & Dining', 'Transportation', 'Shopping']);
            updateBudgetLegend(['Used', 'Remaining']);
            
            // Dashboard Chart (Doughnut)
            const dashboardCtx = document.getElementById('dashboardChart').getContext('2d');
            charts.dashboard = new Chart(dashboardCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#00FF88', '#FF4757', '#FFA726', '#00D4FF',
                            '#FF6B9D', '#C44569', '#7ED321', '#FF9500'
                        ]
                    }]
                },
                options: chartOptions
            });
            
            // Budget Overview Chart (Bar)
            const budgetOverviewCtx = document.getElementById('budgetOverviewChart').getContext('2d');
            charts.budget = new Chart(budgetOverviewCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Budget',
                        data: [],
                        backgroundColor: '#6B7280'
                    }, {
                        label: 'Spent',
                        data: [],
                        backgroundColor: '#00FF88'
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: isDark ? '#334155' : '#E5E7EB'
                            }
                        },
                        x: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: isDark ? '#334155' : '#E5E7EB'
                            }
                        }
                    }
                }
            });
            
            // Monthly Overview Chart (Line)
            const monthlyCtx = document.getElementById('monthlyOverviewChart').getContext('2d');
            charts.monthly = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Income',
                        data: [],
                        borderColor: '#00FF88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Expenses',
                        data: [],
                        borderColor: '#FF4757',
                        backgroundColor: 'rgba(255, 71, 87, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: isDark ? '#334155' : '#E5E7EB'
                            }
                        },
                        x: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: isDark ? '#334155' : '#E5E7EB'
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            updateExpenseChart();
            updateBudgetDonutChart();
            updateDashboardChart();
            updateBudgetChart();
            updateMonthlyChart();
        }

        // Stable color mapping function to ensure consistent colors across updates
        function getStableColor(category, index) {
            const colors = ['#00FF88', '#FF4757', '#FFA726', '#00D4FF', '#FF6B9D', '#C44569', '#7ED321', '#FF9500', 
                           '#42A5F5', '#AB47BC', '#66BB6A', '#FF7043', '#FFCA28', '#8BC34A', '#FF5722', '#9C27B0'];
            
            // Use category name hash for stable color assignment
            let hash = 0;
            for (let i = 0; i < category.length; i++) {
                const char = category.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            
            // Fallback to index if hash fails, ensure we stay within color array bounds
            const colorIndex = Math.abs(hash) % colors.length;
            return colors[colorIndex] || colors[index % colors.length];
        }

        function updateExpenseChart() {
            const expensesByCategory = getExpensesByCategory();
            
            // Sort categories by amount descending to maintain consistent ordering
            const sortedEntries = Object.entries(expensesByCategory)
                .sort(([,a], [,b]) => b - a);
            
            const categories = sortedEntries.map(([category]) => category);
            const amounts = sortedEntries.map(([,amount]) => amount);
            
            if (categories.length === 0) {
                // Show default data instead of empty state
                charts.expense.data.labels = ['Food & Dining', 'Transportation', 'Shopping'];
                charts.expense.data.datasets[0].data = [40, 30, 30];
                charts.expense.data.datasets[0].backgroundColor = ['#00FF88', '#FF4757', '#FFA726'];
                updateExpenseLegend(['Food & Dining', 'Transportation', 'Shopping']);
            } else {
                // Generate colors for all categories using stable color mapping
                const backgroundColor = categories.map((category, index) => getStableColor(category, index));
                
                charts.expense.data.labels = categories;
                charts.expense.data.datasets[0].data = amounts;
                charts.expense.data.datasets[0].backgroundColor = backgroundColor;
                
                // Update legend with all categories
                updateExpenseLegend(categories);
            }
            
            charts.expense.update();
        }

        function updateBudgetDonutChart() {
            let filteredBudgets = budgets;
            
            // Filter budgets based on selected filter
            if (selectedBudgetFilter !== 'all') {
                filteredBudgets = budgets.filter(b => b.id === selectedBudgetFilter);
            }
            
            const totalBudget = filteredBudgets.reduce((sum, b) => sum + b.amount, 0);
            const totalSpent = filteredBudgets.reduce((sum, b) => {
                const spent = transactions
                    .filter(t => t.type === 'expense' && t.category === b.category)
                    .reduce((sum, t) => sum + Math.abs(t.amount), 0);
                return sum + spent;
            }, 0);
            
            if (totalBudget > 0) {
                const remaining = Math.max(0, totalBudget - totalSpent);
                const usedPercentage = (totalSpent / totalBudget) * 100;
                
                charts.budgetDonut.data.labels = ['Used', 'Remaining'];
                charts.budgetDonut.data.datasets[0].data = [totalSpent, remaining];
                charts.budgetDonut.data.datasets[0].backgroundColor = [
                    usedPercentage > 100 ? '#FF4757' : '#00FF88',
                    '#E5E7EB'
                ];
                updateBudgetLegend(['Used', 'Remaining']);
            } else {
                // Show default data instead of empty state
                charts.budgetDonut.data.labels = ['Used', 'Remaining'];
                charts.budgetDonut.data.datasets[0].data = [30, 70];
                charts.budgetDonut.data.datasets[0].backgroundColor = ['#00FF88', '#E5E7EB'];
                updateBudgetLegend(['Used', 'Remaining']);
            }
            
            charts.budgetDonut.update();
        }

        function updateExpenseLegend(categories, amounts) {
            const legendGrid = document.getElementById('expenseLegendGrid');
            
            if (!legendGrid) return;
            
            // Build legend items from the exact same data used by the chart
            const legendHTML = categories.map((category, index) => {
                const color = getStableColor(category, index);
                
                return `
                    <div class="legend-item legend-visible">
                        <div class="legend-dot" style="background-color: ${color};"></div>
                        <span>${category}</span>
                    </div>
                `;
            }).join('');
            
            legendGrid.innerHTML = legendHTML;
            
            // Reset expansion state and update visibility based on current state
            const isExpanded = legendGrid.classList.contains('expanded');
            const allLegendItems = legendGrid.querySelectorAll('.legend-item');
            const visibleItemsCount = 6; // Number of items initially visible when collapsed
            
            if (!isExpanded && allLegendItems.length > visibleItemsCount) {
                // Hide items beyond the visible count when collapsed
                allLegendItems.forEach((item, index) => {
                    if (index >= visibleItemsCount) {
                        item.classList.remove('legend-visible');
                        item.classList.add('legend-hidden');
                    }
                });
            }
            
            // Update expand button visibility
            const expandBtn = document.getElementById('expenseLegendExpandBtn');
            if (expandBtn) {
                expandBtn.style.display = allLegendItems.length > visibleItemsCount ? 'flex' : 'none';
            }
        }

        function updateBudgetLegend(labels) {
            const legendContainer = document.getElementById('budgetLegend');
            
            if (!legendContainer) return;
            
            legendContainer.innerHTML = `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4F46E5"></div>
                    <span>Used</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #E5E7EB"></div>
                    <span>Remaining</span>
                </div>
            `;
        }

        function updateDashboardChart() {
            if (!charts.dashboard) return;
            
            const expensesByCategory = getExpensesByCategory();
            
            // Sort categories by amount descending for consistency with expense chart
            const sortedEntries = Object.entries(expensesByCategory)
                .sort(([,a], [,b]) => b - a);
            
            const categories = sortedEntries.map(([category]) => category);
            const amounts = sortedEntries.map(([,amount]) => amount);
            
            if (categories.length === 0) {
                // Show empty state or hide chart
                charts.dashboard.data.labels = [];
                charts.dashboard.data.datasets[0].data = [];
                charts.dashboard.data.datasets[0].backgroundColor = [];
            } else {
                // Use the same stable color mapping as the expense chart
                const backgroundColor = categories.map((category, index) => getStableColor(category, index));
                
                charts.dashboard.data.labels = categories;
                charts.dashboard.data.datasets[0].data = amounts;
                charts.dashboard.data.datasets[0].backgroundColor = backgroundColor;
            }
            
            charts.dashboard.update();
        }

        function updateBudgetChart() {
            if (!charts.budget) return;
            
            const budgetLabels = budgets.map(b => b.category);
            const budgetAmounts = budgets.map(b => b.amount);
            const spentAmounts = budgets.map(b => {
                return transactions
                    .filter(t => t.type === 'expense' && t.category === b.category)
                    .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            });
            
            charts.budget.data.labels = budgetLabels;
            charts.budget.data.datasets[0].data = budgetAmounts;
            charts.budget.data.datasets[1].data = spentAmounts;
            charts.budget.update();
        }

        function updateMonthlyChart() {
            if (!charts.monthly) return;
            
            const monthlyData = getMonthlyData();
            
            charts.monthly.data.labels = monthlyData.labels;
            charts.monthly.data.datasets[0].data = monthlyData.income;
            charts.monthly.data.datasets[1].data = monthlyData.expenses;
            charts.monthly.update();
        }

        function getExpensesByCategory() {
            const expensesByCategory = {};
            
            transactions
                .filter(t => t.type === 'expense')
                .forEach(transaction => {
                    const category = transaction.category || 'Other';
                    expensesByCategory[category] = (expensesByCategory[category] || 0) + Math.abs(transaction.amount);
                });
            
            return expensesByCategory;
        }

        function getMonthlyData() {
            const monthlyIncome = {};
            const monthlyExpenses = {};
            
            transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (transaction.type === 'income') {
                    monthlyIncome[monthKey] = (monthlyIncome[monthKey] || 0) + Math.abs(transaction.amount);
                } else {
                    monthlyExpenses[monthKey] = (monthlyExpenses[monthKey] || 0) + Math.abs(transaction.amount);
                }
            });
            
            const allMonths = [...new Set([...Object.keys(monthlyIncome), ...Object.keys(monthlyExpenses)])].sort();
            
            return {
                labels: allMonths.map(month => {
                    const [year, monthNum] = month.split('-');
                    return new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                }),
                income: allMonths.map(month => monthlyIncome[month] || 0),
                expenses: allMonths.map(month => monthlyExpenses[month] || 0)
            };
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        }

        function getIconForCategory(category) {
            const icons = {
                'Food & Dining': '🍽️',
                'Transportation': '🚗',
                'Shopping': '🛍️',
                'Entertainment': '🎬',
                'Bills & Utilities': '💡',
                'Healthcare': '🏥',
                'Education': '📚',
                'Travel': '✈️',
                'Personal Care': '💄',
                'Gifts & Donations': '🎁',
                'Other': '📝',
                'Salary': '💼',
                'Freelance': '💻',
                'Business': '🏢',
                'Investments': '📈',
                'Rental Income': '🏠',
                'Gifts': '🎁'
            };
            return icons[category] || '📝';
        }

        function getIconBackground(category) {
            const colors = [
                '#4F46E5', '#10B981', '#F59E0B', '#EF4444',
                '#8B5CF6', '#06B6D4', '#84CC16', '#F97316',
                '#EC4899', '#6B7280', '#14B8A6', '#F43F5E'
            ];
            const index = category.charCodeAt(0) % colors.length;
            return colors[index] + '20';
        }

        function toggleRecurringOptions() {
            const recurringOptions = document.getElementById('recurringOptions');
            const isChecked = document.getElementById('recurring').checked;
            recurringOptions.style.display = isChecked ? 'block' : 'none';
        }

        function toggleSavingsOptions() {
            const savingsOptions = document.getElementById('savingsOptions');
            const isChecked = document.getElementById('contributeSavings').checked;
            savingsOptions.style.display = isChecked ? 'block' : 'none';
            
            if (isChecked) {
                updateSavingsGoalOptions();
            }
        }

        function updateSavingsGoalOptions() {
            const savingsGoalSelect = document.getElementById('savingsGoal');
            savingsGoalSelect.innerHTML = '<option value="">Select savings goal</option>';
            
            goals.forEach(goal => {
                if (goal.current < goal.target) { // Only show incomplete goals
                    savingsGoalSelect.innerHTML += `<option value="${goal.id}">${goal.name}</option>`;
                }
            });
        }

        function toggleDebtOptions() {
            const debtOptions = document.getElementById('debtOptions');
            const isChecked = document.getElementById('contributeDebt').checked;
            debtOptions.style.display = isChecked ? 'block' : 'none';
            
            if (isChecked) {
                updateDebtGoalOptions();
            }
        }

        function updateDebtGoalOptions() {
            const debtGoalSelect = document.getElementById('debtGoal');
            debtGoalSelect.innerHTML = '<option value="">Select debt goal</option>';
            
            debts.forEach(debt => {
                if (debt.paid < debt.amount) { // Only show unpaid debts
                    debtGoalSelect.innerHTML += `<option value="${debt.id}">${debt.name}</option>`;
                }
            });
        }

        function toggleExpenseLegend() {
            const expandBtn = document.getElementById('expenseLegendExpandBtn');
            const expandText = document.getElementById('expenseLegendExpandText');
            const expandIcon = document.getElementById('expenseLegendExpandIcon');
            
            const legendGrid = document.getElementById('expenseLegendGrid');
            const allLegendItems = legendGrid.querySelectorAll('.legend-item');
            const visibleItemsCount = 6; // Number of items initially visible when collapsed
            
            const isExpanded = legendGrid.classList.contains('expanded');

            if (isExpanded) {
                // Currently expanded, so collapse - show only first 6 items
                allLegendItems.forEach((item, index) => {
                    if (index >= visibleItemsCount) {
                        item.classList.remove('legend-visible');
                        item.classList.add('legend-hidden');
                    }
                });
                legendGrid.classList.remove('expanded');
                expandText.textContent = 'Show More';
                expandIcon.classList.remove('rotated');
            } else {
                // Currently collapsed, so expand - show ALL items (no limits)
                allLegendItems.forEach(item => {
                    item.classList.remove('legend-hidden');
                    item.classList.add('legend-visible');
                });
                legendGrid.classList.add('expanded');
                expandText.textContent = 'Show Less';
                expandIcon.classList.add('rotated');
            }
        }

        let selectedBudgetFilter = 'all';

        function toggleBudgetDropdown() {
            const menu = document.getElementById('budgetDropdownMenu');
            const arrow = document.querySelector('.dropdown-arrow');
            
            menu.classList.toggle('show');
            arrow.classList.toggle('rotated');
        }

        function selectBudget(budgetId) {
            selectedBudgetFilter = budgetId;
            
            // Update selected budget name
            const selectedName = document.getElementById('selectedBudgetName');
            if (budgetId === 'all') {
                selectedName.textContent = 'All Budgets';
            } else {
                const budget = budgets.find(b => b.id === budgetId);
                selectedName.textContent = budget ? budget.category : 'All Budgets';
            }
            
            // Update active state in dropdown
            document.querySelectorAll('.budget-dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Close dropdown
            document.getElementById('budgetDropdownMenu').classList.remove('show');
            document.querySelector('.dropdown-arrow').classList.remove('rotated');
            
            // Update budget chart
            updateBudgetDonutChart();
        }

        function updateBudgetDropdown() {
            const container = document.getElementById('budgetDropdownContainer');
            const menu = document.getElementById('budgetDropdownMenu');
            
            // Show dropdown when there are budgets (even just one for demonstration)
            if (budgets.length >= 1) {
                container.style.display = 'block';
                
                // Update dropdown menu items
                menu.innerHTML = `
                    <div class="budget-dropdown-item ${selectedBudgetFilter === 'all' ? 'active' : ''}" onclick="selectBudget('all')">All Budgets</div>
                    ${budgets.map(budget => `
                        <div class="budget-dropdown-item ${selectedBudgetFilter === budget.id ? 'active' : ''}" onclick="selectBudget(${budget.id})">${budget.category}</div>
                    `).join('')}
                `;
            } else {
                container.style.display = 'none';
                selectedBudgetFilter = 'all';
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            if (type === 'error') {
                notification.style.background = 'var(--danger)';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Data persistence
        
        // Open contribute-to-debt modal for a specific debt
        function showContributeDebtModal(id) {
            const debt = debts.find(d => d.id === id);
            if (!debt) return;
            selectedDebtIdForContribution = id;
            document.getElementById('contributeDebtName').value = debt.name;
            document.getElementById('contributeDebtAmount').value = '';
            document.getElementById('contributeDebtNote').value = '';
            showModal('contributeDebtModal');
        }

        // Apply a payment to the selected debt
        function contributeToDebt() {
            if (selectedDebtIdForContribution === null) return;
            const amount = parseFloat(document.getElementById('contributeDebtAmount').value);
            if (isNaN(amount) || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }
            const debt = debts.find(d => d.id === selectedDebtIdForContribution);
            if (!debt) return;
            const remaining = Math.max(0, debt.amount - debt.paid);
            const payment = Math.min(amount, remaining);
            debt.paid = (debt.paid || 0) + payment;

            // Optional: log a transaction (keeps existing Transactions UI intact)
            transactions.push({
                id: Date.now(),
                type: 'debtPayment',
                category: debt.name,
                amount: payment,
                date: new Date().toISOString().slice(0,10),
                note: document.getElementById('contributeDebtNote').value || 'Debt payment'
            });

            saveData();
            updateDebtsList();
            updateTransactionsList && updateTransactionsList();
            updateDashboard && updateDashboard();

            closeModal('contributeDebtModal');
            showNotification('Payment added');
        }
        function updateGoalsProgressBar(pct) {
            const bar = document.getElementById('goalsProgressBar');
            if (bar) bar.style.width = Math.max(0, Math.min(100, pct)) + '%';
        }

function saveData() {
            localStorage.setItem('budgetTracker', JSON.stringify({
                transactions,
                budgets,
                goals,
                debts,
                settings
            }));
        }

        function loadData() {
            const data = localStorage.getItem('budgetTracker');
            if (data) {
                const parsed = JSON.parse(data);
                transactions = parsed.transactions || [];
                budgets = parsed.budgets || [];
                goals = parsed.goals || [];
                debts = parsed.debts || [];
                settings = { ...settings, ...parsed.settings };
            }
        }

        // Export/Import functions
        function exportJSON() {
            const data = {
                transactions,
                budgets,
                goals,
                settings,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget-tracker-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            closeModal('menuModal');
            showNotification('Data exported successfully');
        }

        function exportCSV() {
            if (transactions.length === 0) {
                showNotification('No transactions to export', 'error');
                return;
            }
            
            const headers = ['Date', 'Description', 'Category', 'Type', 'Amount'];
            const csvContent = [
                headers.join(','),
                ...transactions.map(t => [
                    new Date(t.date).toLocaleDateString(),
                    `"${t.description}"`,
                    `"${t.category}"`,
                    t.type,
                    Math.abs(t.amount)
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transactions-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            closeModal('menuModal');
            showNotification('Transactions exported successfully');
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.transactions) transactions = data.transactions;
                    if (data.budgets) budgets = data.budgets;
                    if (data.goals) goals = data.goals;
                    if (data.settings) settings = { ...settings, ...data.settings };
                    
                    saveData();
                    updateDashboard();
                    closeModal('menuModal');
                    showNotification('Data imported successfully');
                } catch (error) {
                    showNotification('Invalid file format', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Search functionality
        function filterTransactions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredTransactions = transactions.filter(transaction => 
                transaction.description.toLowerCase().includes(searchTerm) ||
                transaction.category.toLowerCase().includes(searchTerm)
            );
            
            displaySearchResults(filteredTransactions);
        }

        function filterByType(type) {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.classList.add('active');
            
            let filteredTransactions;
            if (type === 'all') {
                filteredTransactions = transactions;
            } else {
                filteredTransactions = transactions.filter(t => t.type === type);
            }
            
            displaySearchResults(filteredTransactions);
        }

        function displaySearchResults(filteredTransactions) {
            const container = document.getElementById('searchResults');
            
            if (filteredTransactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <div class="empty-state-text">No transactions found</div>
                        <div class="empty-state-subtext">Try adjusting your search criteria</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredTransactions.map(transaction => `
                <div class="transaction-item">
                    <div class="transaction-left">
                        <div class="transaction-icon" style="background: ${getIconBackground(transaction.category)}">
                            ${getIconForCategory(transaction.category)}
                        </div>
                        <div class="transaction-info">
                            <div class="transaction-description">${transaction.description}</div>
                            <div class="transaction-meta">
                                ${transaction.category} • ${formatDate(transaction.date)}
                            </div>
                        </div>
                    </div>
                    <div class="transaction-right">
                        <div class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : ''}${formatCurrency(Math.abs(transaction.amount))}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                const modalId = event.target.id;
                closeModal(modalId);
            }
        });

        // Keyboard shortcuts
        // Contribute funds functionality
        function showContributeFundsModal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            document.getElementById('contributeGoalName').value = goal.name;
            document.getElementById('contributeAmount').value = '';
            document.getElementById('contributeNote').value = '';
            
            // Store the goal ID for later use
            document.getElementById('contributeFundsModal').setAttribute('data-goal-id', goalId);
            
            showModal('contributeFundsModal');
        }
        
        function contributeToGoal() {
            const goalId = parseInt(document.getElementById('contributeFundsModal').getAttribute('data-goal-id'));
            const amount = parseFloat(document.getElementById('contributeAmount').value);
            const note = document.getElementById('contributeNote').value;
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid contribution amount', 'error');
                return;
            }
            
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            // Update goal current amount
            goal.current += amount;
            
            // Add a transaction record for the contribution
            const contribution = {
                id: Date.now(),
                type: 'contribution',
                description: `Contribution to ${goal.name}${note ? ` - ${note}` : ''}`,
                amount: amount,
                category: 'Savings',
                date: new Date().toISOString().split('T')[0],
                recurring: false
            };
            
            transactions.push(contribution);
            
            // Save to localStorage
            localStorage.setItem('goals', JSON.stringify(goals));
            localStorage.setItem('transactions', JSON.stringify(transactions));
            
            // Update displays
            updateGoalsList();
            updateTransactionsList();
            updateBalanceCard();
            updateQuickStats();
            
            closeModal('contributeFundsModal');
            showNotification(`Successfully contributed ${formatCurrency(amount)} to ${goal.name}!`);
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    closeModal(activeModal.id);
                }
            }
        });

        // Confetti Animation System
        (() => {
            // ---------- Utilities ----------
            const parseMoney = (str) => {
                // accepts '$10,000.00' or '10000' etc.
                if (typeof str !== 'string') return Number(str || 0);
                return Number(str.replace(/[^0-9.\-]/g, '')) || 0;
            };

            const lsKey = (goalId) => `savings_goal_celebrated:${goalId}`;

            // ---------- Confetti ----------
            const Confetti = {
                burst(count = 48) {
                    for (let i = 0; i < count; i++) {
                        const n = document.createElement('div');
                        n.className = 'confetti';
                        n.style.left = (Math.random() * window.innerWidth) + 'px';
                        n.style.backgroundColor = `hsl(${Math.random() * 360},100%,55%)`;
                        n.style.transform = `translateY(0) rotate(${Math.random()*60-30}deg)`;
                        n.style.setProperty('--cfdur', (2 + Math.random() * 1.5) + 's');
                        document.body.appendChild(n);
                        setTimeout(() => n.remove(), 3500);
                    }
                }
            };

            // ---------- Goal Check ----------
            function maybeCelebrate(goalEl) {
                if (!goalEl) return;
                const goalId = goalEl.dataset.goalId || 'goal-unknown';
                // Already celebrated?
                if (localStorage.getItem(lsKey(goalId)) === '1') return;

                const current = parseMoney(goalEl.dataset.current);
                const target  = parseMoney(goalEl.dataset.target);
                if (target > 0 && current >= target) {
                    Confetti.burst(56);
                    localStorage.setItem(lsKey(goalId), '1'); // fire once
                }
            }

            // Optional helper: reset celebration flag (call when user edits goal downward, etc.)
            window.resetGoalCelebration = (goalId) => localStorage.removeItem(lsKey(goalId));

            // ---------- Check for Goal Achievement ----------
            // Function to check all goals for achievements after updates
            function checkAllGoalsForAchievement() {
                const goalCards = document.querySelectorAll('.savings-card');
                goalCards.forEach(card => {
                    const goalId = card.dataset.goalId;
                    if (goalId) {
                        const goalIdNum = parseInt(goalId.replace('goal-', ''));
                        const goal = goals.find(g => g.id === goalIdNum);
                        if (goal) {
                            // Update data attributes to reflect current state
                            card.dataset.current = formatCurrency(goal.current);
                            card.dataset.target = formatCurrency(goal.target);
                            // Check if this goal should trigger confetti
                            maybeCelebrate(card);
                        }
                    }
                });
            }

            // Hook into the existing updateGoalsList function to check for achievements
            const originalUpdateGoalsList = window.updateGoalsList;
            window.updateGoalsList = function() {
                originalUpdateGoalsList.call(this);
                // Check for achievements after the goals list is updated
                setTimeout(checkAllGoalsForAchievement, 50);
            };
        })();
    </script>
</body>
</html>
